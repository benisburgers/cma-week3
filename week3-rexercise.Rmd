---
title: "Week 3 Exercises"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

# Tasks and Inputs

## Task 1: Segmentation

### Install libraries

```{r warning = FALSE, message = FALSE}
library(tidyverse)
library(cowplot)
```

### Import Data

```{r}
caro <- read_delim('caro60.csv')
caro
```

### Custom-Segment the Data

```{r}
caro <- caro %>%
  mutate(
    nMinus3 = sqrt((lag(E,3)-E)^2+(lag(N,3)-N)^2),   # distance to pos -3 minutes
    nMinus2 = sqrt((lag(E,2)-E)^2+(lag(N,2)-N)^2),   # distance to pos -2 minutes
    nMinus1 = sqrt((lag(E,1)-E)^2+(lag(N,1)-N)^2),   # distance to pos -1 minutes
    nPlus1  = sqrt((E-lead(E,1))^2+(N-lead(N,1))^2), # distance to pos +1 mintues
    nPlus2  = sqrt((E-lead(E,2))^2+(N-lead(N,2))^2), # distance to pos +2 minutes
    nPlus3  = sqrt((E-lead(E,3))^2+(N-lead(N,3))^2)  # distance to pos +3 minutes
  )
caro
```

## Task 2: Specify and apply threshold *d*

### Exploring the distances between positions

```{r, warning=FALSE}
caro %>%
ggplot() +
  geom_histogram(mapping = aes(x = nMinus3))

caro %>%
ggplot() +
  geom_histogram(mapping = aes(x = nMinus2))
```

### Calculating the mean distance for every row

```{r}
caro <- caro %>%
  rowwise() %>%
  mutate(
    stepMean = mean(c(nMinus3, nMinus2, nMinus1, nPlus1, nPlus2, nPlus3))
  ) %>%
  ungroup()

caro
```

### Exploring the mean distances between positions

```{r}
caro %>%
  ggplot() +
  geom_histogram(mapping = aes(x = stepMean))

caro %>%
  ggplot() +
  geom_histogram(mapping = aes(x = stepMean)) +
  xlim(0, 10)
```
### Removing 'static' points

```{r}
# Static = Check whether the row step mean is lower than the overall steapMean average
caro <- caro %>%
    mutate(static = stepMean < mean(stepMean, na.rm = TRUE))
caro

# Moving = Only the points where the row average is larger than the overall average
caro_moving <- caro %>%
  filter(static == FALSE)
caro_moving
```
## Task 3: Visualize segmented trajectories

```{r}
caro %>%
  ggplot(mapping = aes(x = E, y = N)) +
  geom_path() +
  geom_point(mapping = aes(color = static)) +
  coord_equal()
```
## Task 4: Segment-based analysis
```{r, warning=FALSE}
# No idea how this works:
rle_id <- function(vec){
  x <- rle(vec)$lengths
  as.factor(rep(seq_along(x), times=x))
}

caro <- caro %>%
  mutate(segment_id = rle_id(static))
caro

# IMO: A segment is done when the next begins, as such get access to the next data points time.
caro <- caro %>%
  mutate(nextDatetimeUTC = lead(DatetimeUTC, 1))

# Calculate segment duration by using the start_time of each segment and getting the next segment's start time
# I.e. one segment ends when the next one begins
segment_duration <- caro %>%
  group_by(segment_id) %>%
  summarise(start = min(DatetimeUTC),
            end = max(nextDatetimeUTC)) %>%
  mutate(duration_m = as.numeric(difftime(end, start)))
segment_duration

# Add segment_duration to caro
caro <- caro %>%
  left_join(segment_duration, by = "segment_id")

# Create a convenience variable whether a segment is longer or equal to 5 minutes
caro <- caro %>%
  mutate(segment_duration_5 = ifelse(duration_m >= 5, TRUE, FALSE))
caro

# Plot all segments that are not static
plot_all <- caro %>%
filter(static == FALSE) %>%
ggplot(mapping = aes(x = E, y = N, color = segment_id)) +
geom_path() +
geom_point() +
theme(legend.position = "bottom")
plot_all

# Plot all segments that are not static AND that are longer or equal to 5 minutes
plot_longer_than_5_minutes <- caro %>%
filter(static == FALSE) %>%
filter(segment_duration_5 == TRUE) %>%
ggplot(mapping = aes(x = E, y = N, color = segment_id)) +
geom_path() +
geom_point() +
theme(legend.position = "bottom")
plot_longer_than_5_minutes

# Combine these plots
plot_grid(plot_all, plot_longer_than_5_minutes)

```
Hey there! I'm not sure that I agree with your example in the exercise. For examle, segment 16 starts at 2015-09-15 11:19:00 and ends at 2015-09-15 11:25:00 when segment 17 begins. In my opinion that makes more sense, because a segment that has only 1 step (e.g. Segment 1) still has to be at least 1 minute long. And even if you don't agree with me, then segmend 16 would end at 2015-09-15 11:24:00, still making it 5 minutes long. Thereby we would have to show it. But maybe my calculations are also wrong somewhere.

## Task 5: Similarity measures

Import the data

```{r, warning=FALSE}
pedastrian <- read_delim('pedestrian.csv')
pedastrian
```

Visualize the data

```{r}
pedastrian %>%
  ggplot(mapping = aes(x = E, y = N, color = as.factor(TrajID))) +
  geom_point() +
  geom_path() +
  facet_wrap(~as.factor(TrajID))
```
## Task 6: Calculate similarity

### Install packages and read about them

```{r, warning=FALSE}
library(SimilarityMeasures)
help(package = "SimilarityMeasures")
```

### Create trajectory matrixes for every pedastrian

```{r, warning=FALSE}
# Matrix 1

pedastrian1 <- 
  pedastrian %>%
  filter(TrajID == 1) %>%
  select(N, E)
pedastrian1

pedastrian1_matrix <- matrix(c(pedastrian1$E, pedastrian1$N), ncol = 2)
pedastrian1_matrix

# Matrix 2

pedastrian2 <- 
  pedastrian %>%
  filter(TrajID == 2) %>%
  select(N, E)
pedastrian2

pedastrian2_matrix <- matrix(c(pedastrian2$E, pedastrian2$N), ncol = 2)
pedastrian2_matrix

# Matrix 3

pedastrian3 <- 
  pedastrian %>%
  filter(TrajID == 3) %>%
  select(N, E)
pedastrian3

pedastrian3_matrix <- matrix(c(pedastrian3$E, pedastrian3$N), ncol = 2)
pedastrian3_matrix

# Matrix 4

pedastrian4 <- 
  pedastrian %>%
  filter(TrajID == 4) %>%
  select(N, E)
pedastrian4

pedastrian4_matrix <- matrix(c(pedastrian4$E, pedastrian4$N), ncol = 2)
pedastrian4_matrix

# Matrix 5

pedastrian5 <- 
  pedastrian %>%
  filter(TrajID == 5) %>%
  select(N, E)
pedastrian5

pedastrian5_matrix <- matrix(c(pedastrian5$E, pedastrian5$N), ncol = 2)
pedastrian5_matrix

# Matrix 6

pedastrian6 <- 
  pedastrian %>%
  filter(TrajID == 6) %>%
  select(N, E)
pedastrian6

pedastrian6_matrix <- matrix(c(pedastrian6$E, pedastrian6$N), ncol = 2)
pedastrian6_matrix

```


### Calculate the trajectory similarities for each 1:n pair and with every method

```{r, warning=FALSE}
DTW <- c()
DTW[1] <- DTW(pedastrian1_matrix, pedastrian2_matrix)
DTW[2] <- DTW(pedastrian1_matrix, pedastrian3_matrix)
DTW[3] <- DTW(pedastrian1_matrix, pedastrian4_matrix)
DTW[4] <- DTW(pedastrian1_matrix, pedastrian5_matrix)
DTW[5] <- DTW(pedastrian1_matrix, pedastrian6_matrix)
DTW

EditDist <- c()
EditDist[1] <- EditDist(pedastrian1_matrix, pedastrian2_matrix)
EditDist[2] <- EditDist(pedastrian1_matrix, pedastrian3_matrix)
EditDist[3] <- EditDist(pedastrian1_matrix, pedastrian4_matrix)
EditDist[4] <- EditDist(pedastrian1_matrix, pedastrian5_matrix)
EditDist[5] <- EditDist(pedastrian1_matrix, pedastrian6_matrix)
EditDist

Frechet <- c()
Frechet[1] <- Frechet(pedastrian1_matrix, pedastrian2_matrix)
Frechet[2] <- Frechet(pedastrian1_matrix, pedastrian3_matrix)
Frechet[3] <- Frechet(pedastrian1_matrix, pedastrian4_matrix)
Frechet[4] <- Frechet(pedastrian1_matrix, pedastrian5_matrix)
Frechet[5] <- Frechet(pedastrian1_matrix, pedastrian6_matrix)
Frechet

LCSS <- c()
LCSS[1] <- LCSS(pedastrian1_matrix, pedastrian2_matrix, 2, 2, 0.5)
LCSS[2] <- LCSS(pedastrian1_matrix, pedastrian3_matrix, 2, 2, 0.5)
LCSS[3] <- LCSS(pedastrian1_matrix, pedastrian4_matrix, 2, 2, 0.5)
LCSS[4] <- LCSS(pedastrian1_matrix, pedastrian5_matrix, 2, 2, 0.5)
LCSS[5] <- LCSS(pedastrian1_matrix, pedastrian6_matrix, 2, 2, 0.5)
LCSS
```

# Visualizing the results from the simliarity measures

```{r, warning=FALSE}

results <- tibble(DTW, EditDist, Frechet, path = as.factor(c(2, 3, 4, 5, 6)))
results

results_long <- results %>% pivot_longer(names_to = "name", values_to = "value", -path)
results_long

results_long %>%
  ggplot() +
  geom_col(mapping = aes(x = path, y = value)) +
  facet_wrap(~name)

DTW_plot <- results_long %>%
  filter(name == "DTW") %>%
  ggplot() +
  geom_col(mapping = aes(x = path, y = value, fill = path))
DTW_plot

EditDist_plot <- results_long %>%
  filter(name == "EditDist") %>%
  ggplot() +
  geom_col(mapping = aes(x = path, y = value, fill = path))
EditDist_plot

FrechetDist_plot <- results_long %>%
  filter(name == "FrechetDist") %>%
  ggplot() +
  geom_col(mapping = aes(x = path, y = value, fill = path))
FrechetDist_plot

LCSS_plot <- results_long %>%
  filter(name == "LCSS") %>%
  ggplot() +
  geom_col(mapping = aes(x = path, y = value, fill = path))
LCSS_plot

plot_grid(DTW_plot, EditDist_plot, FrechetDist_plot, LCSS_plot)

```
Why on earth do my plots look so much different than the ones provided by the examples?

